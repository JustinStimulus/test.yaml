# Scale deployment to 0 to completely stop the process
kubectl scale deployment stimulus-web -n stimulus-uat --replicas=0

# Update ALL environment variables in one go to force complete reload
kubectl patch deployment stimulus-web -n stimulus-uat --type=json -p='[
  {"op": "replace", "path": "/spec/template/spec/containers/0/env", "value": [
    {"name": "PORT", "value": "3000"},
    {"name": "HOSTNAME", "value": "0.0.0.0"},
    {"name": "NODE_ENV", "value": "production"},
    {"name": "NEXT_TELEMETRY_DISABLED", "value": "1"},
    {"name": "DEPLOYMENT", "value": "uat"},
    {"name": "NEXT_PUBLIC_AGENTS_DEPLOYMENT_URL", "value": "http://stimulus-agents.stimulus-uat.svc.cluster.local:8001"},
    {"name": "NEXT_PUBLIC_AGENTS_BACKEND_URL", "value": "http://localhost:8123"},
    {"name": "LANGSMITH_API_KEY", "valueFrom": {"secretKeyRef": {"name": "stimulus-secrets", "key": "langsmith-api-key"}}},
    {"name": "OPENAI_API_KEY", "valueFrom": {"secretKeyRef": {"name": "stimulus-secrets", "key": "openai-api-key"}}},
    {"name": "NEXT_PUBLIC_API_URL", "valueFrom": {"secretKeyRef": {"name": "stimulus-secrets", "key": "next-public-api-url"}}},
    {"name": "BACKEND_API_URL", "valueFrom": {"secretKeyRef": {"name": "stimulus-secrets", "key": "backend-api-url"}}}
  ]}
]'

# Scale back to 1 to force fresh process start
kubectl scale deployment stimulus-web -n stimulus-uat --replicas=1

# Wait for deployment
kubectl rollout status deployment stimulus-web -n stimulus-uat
